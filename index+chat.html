<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="theme-color" content="gray">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Battle City</title>
	<script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
	<style>
		.github-corner:hover .octo-arm {
			animation: octocat-wave 560ms ease-in-out
		}

		@keyframes octocat-wave {

			0%,
			100% {
				transform: rotate(0)
			}

			20%,
			60% {
				transform: rotate(-25deg)
			}

			40%,
			80% {
				transform: rotate(10deg)
			}
		}

		@media (max-width: 500px) {
			.github-corner:hover .octo-arm {
				animation: none
			}

			.github-corner .octo-arm {
				animation: octocat-wave 560ms ease-in-out
			}
		}

		#chat {
			width: 400px;
			border: 2px dotted blue
		}
	</style>
</head>

<body>
	<div id="container"></div>
	<div id="chat">
		<p>
			<span>my id:</span>
			<input id="my_id" class="readonly-input" type="text" size="40" readonly>
			<button onclick="copy_link_to_clipboard()">
				copy link
			</button>
			<input id="my_nickname" type="text" size="12" placeholder="nickname">
		</p>
		<p>
			<input id="peer_id" type="text" size="40" placeholder="peer id" readonly>
			<button id="play_button" style="display: none;" onclick="play_with_peer()">
				play
			</button>
			<button id="screencast_button" style="display: none;" onclick="screencast_to_peer()">
				screencast
			</button>
		</p>
		<table>
			<tbody>
				<tr id="chat_blocks">
					<td id="app_log"></td>
				</tr>
			</tbody>
		</table>
	</div>
	<script>
		const client_keys = {
			KeyI: true, KeyJ: true, KeyK: true, KeyL: true, KeyO: true,
		}
		document.addEventListener('keydown', event => {
			if (is_game_server) {
				if (event.code === "KeyF") {
					const screens = document.getElementsByClassName('screen');
					if (screens) screens[0].requestFullscreen();
				}
			}
			else if (event.code in client_keys) send_input('keydown', event.code);
		});
		document.addEventListener('keyup', event => {
			if (is_game_server)
				;
			else if (event.code in client_keys) send_input('keyup', event.code);
		});
	</script>
	<script>
		let my_peer = new window.Peer();
		let peer_server_connection = my_peer.connect();
		// on open will be launch when you successfully connect to PeerServer
		peer_server_connection.on('open', function () {
			// here you have conn.id
			peer_server_connection.send('register me');
		});
		my_peer.on('open', (id) => {
			const my_id = document.querySelector('#my_id');
			my_id.onfocus = my_id.onclick = event => event.target.select();
			my_id.value = id;
		});
		my_peer.on('error', (error) => {
			log('app_log', `failed to open peer. ${error}`);
			console.error(error);
			console.log(error.stack);
		});
		function log(target, message, type) {
			let new_message = document.createElement('p');
			if (type === 'sent')
				new_message.style.textAlign = 'right';
			else if (type === 'received')
				new_message.style.backgroundColor = '#D0FFF1';
			new_message.innerText = message;
			document.querySelector(`#${target}`).appendChild(new_message);
		}
		let interval_to_clear, is_game_server = true, play_in_progress, main_connection, use_video;
		async function initialize_fields() {
			function init_text(id) {
				const field_element = document.querySelector(`#${id}`);
				const field = localStorage.getItem(id);
				field_element.value = field;
				field_element.onchange = field_element.oninput = event => {
					localStorage.setItem(id, event.target.value);
				};
			}
			init_text('my_nickname');

			const params = new URL(location.href).searchParams;
			peer_id = params.get('peer_id');
			if (peer_id) {
				document.querySelector('#peer_id').value = peer_id;
				is_game_server = false;
				document.getElementById("play_button").style.display = "";
			}
			interval_to_clear = setInterval(() => {
				const screen = document.getElementById("container").getElementsByClassName("screen")[0];
				const about = document.getElementById("container").getElementsByClassName("about")[0];
				const chat = document.getElementById("chat");
				if (!screen || !about)
					return;
				if (!is_game_server) {
					screen.remove();
					about.remove();
				}
				document.getElementById("container").children[0].appendChild(chat);
				clearInterval(interval_to_clear);
			}, 300);

			try {
				await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
				use_video = true;
			}
			catch (error) {
				console.error(error);
				console.log(error.stack);
				use_video = false;
			}
		}
		initialize_fields();
		async function copy_link_to_clipboard() {
			const id = document.querySelector('#my_id').value;
			await navigator.clipboard.writeText(`${location.origin + location.pathname}?peer_id=${id}`);
		}
		function add_call_block(connection_id) {
			const chat_blocks = document.querySelector('#chat_blocks');
			const block = document.createElement('td');
			const video = document.createElement('video');
			video.id = `remote-video-${connection_id}`;
			video.autoplay = true;
			block.appendChild(video);
			chat_blocks.appendChild(block);
			return video;
		}
		function format_message(message) {
			const nickname = document.querySelector('#my_nickname').value;
			return JSON.stringify({ nickname, message });
		}
		window.send_input = function(event_type, code) {
			if (!main_connection) return;
			main_connection.send(format_message(`${event_type}^${code}`))
		}
		function add_chat_block(connection) {
			const connection_id = connection.connectionId;
			const peer_id = connection.peer;
			const chat_blocks = document.querySelector('#chat_blocks');
			const block = document.createElement('td');
			const peer = document.createElement('h3');
			peer.id = `nickname-${connection_id}`;
			peer.textContent = peer_id;
			const chat = document.createElement('div');
			chat.id = connection_id;
			const message = document.createElement('input');
			message.type = 'text';
			function send_message() {
				if (!message.value)
					return;
				log(connection_id, message.value, 'sent');
				connection.send(format_message(message.value));
				message.value = '';
			}
			message.onkeydown = (e) => {
				if (e.code === 'Enter')
					send_message();
			};
			const send = document.createElement('button');
			send.textContent = 'send';
			send.onclick = send_message;
			block.appendChild(peer);
			block.appendChild(chat);
			block.appendChild(message);
			block.appendChild(send);
			chat_blocks.appendChild(block);
			main_connection = connection;
		}
		function update_nickname(connection, nickname) {
			const connection_id = connection.connectionId;
			const peer_id = connection.peer;
			const nickname_element = document.querySelector(`#nickname-${connection_id}`);
			nickname_element.textContent = nickname || peer_id;
		}
		// handle incoming call
		my_peer.on('call', async (incoming_call) => {
			log('app_log', `receiving call from peer...`);
			let stream;
			try {
				stream = await navigator.mediaDevices.getUserMedia({ video: use_video, audio: true });
			}
			catch (error) {
				log('app_log', `failed to get local stream. ${error}`);
				console.error(error);
				console.log(error.stack);
				return;
			}
			try {
				incoming_call.answer(play_in_progress ? undefined : stream);
				const video = add_call_block(incoming_call.connectionId);
				const render_video = stream => video.srcObject = stream;
				incoming_call.on('stream', render_video);
				if (is_game_server) {
					document.getElementById("peer_id").value = incoming_call.peer;
					document.getElementById("screencast_button").style.display = "";
				}
			}
			catch (error) {
				log('app_log', `failed to answer call. ${error}`);
				console.error(error);
				console.log(error.stack);
			};
		});
		// emulate input
		window.emulate_input = function(event_type, code) {
			const eventObj = document.createEvent("Events");
        	eventObj.initEvent(event_type, true, true);
        	eventObj.code = code;
        	document.dispatchEvent(eventObj);
		}
		// handle incoming connection
		my_peer.on('connection', (incoming_connection) => {
			log('app_log', `receiving connection from peer ${incoming_connection.peer}...`);
			incoming_connection.on('data', (data) => {
				const { nickname, message } = JSON.parse(data);
				update_nickname(incoming_connection, nickname);
				if (message.indexOf("^") > -1) {
					const p = message.split("^");
					emulate_input(p[0], p[1]);
				}
				else
					log(incoming_connection.connectionId, message, 'received');
			});
			incoming_connection.on('open', () => {
				add_chat_block(incoming_connection);
				incoming_connection.send(format_message(`peer accepted chat`));
			});
		});
		// start play
		async function play_with_peer() {
			const peer_id_element = document.querySelector('#peer_id');
			const peer_id = peer_id_element.value;
			log('app_log', `playing to peer ${peer_id}...`);

			let outgoing_connection;
			try {
				outgoing_connection = my_peer.connect(peer_id);
			}
			catch (error) {
				log('app_log', `failed to start play. ${error}`);
				console.error(error);
				console.log(error.stack);
				return;
			}
			outgoing_connection.on('open', () => {
				add_chat_block(outgoing_connection);
				outgoing_connection.send(format_message(`peer initiated play`));
			});
			outgoing_connection.on('data', (data) => {
				const { nickname, message } = JSON.parse(data);
				update_nickname(outgoing_connection, nickname);
				log(outgoing_connection.connectionId, message, 'received');
			});

			let stream;
			try {
				stream = await navigator.mediaDevices.getUserMedia({ video: use_video, audio: true });
			}
			catch (error) {
				log('app_log', `failed to get local stream. ${error}`);
				console.error(error);
				console.log(error.stack);
				return;
			}
			try {
				const outgoing_call = my_peer.call(peer_id, stream);
				const video = add_call_block(outgoing_call.connectionId);
				const render_video = stream => video.srcObject = stream;
				outgoing_call.on('stream', render_video);
			}
			catch (error) {
				log('app_log', `failed to start call. ${error}`);
				console.error(error);
				console.log(error.stack);
				return;
			}
			play_in_progress = true;
			document.getElementById("play_button").disabled = true;
		}
		//start screencast
		async function screencast_to_peer() {
			const peer_id = document.getElementById("peer_id").value;
			if (!peer_id)
				return;
			let stream;
			try {
				stream = await navigator.mediaDevices.getDisplayMedia({
					video: true, systemAudio: "include", preferCurrentTab: true, selfBrowserSurface: "include",
				});
			}
			catch (error) {
				log('app_log', `failed to get local screen stream. ${error}`);
				console.error(error);
				console.log(error.stack);
				return;
			}
			try {
				const outgoing_call = my_peer.call(peer_id, stream);
				const video = add_call_block(outgoing_call.connectionId);
				const render_video = stream => video.srcObject = stream;
				outgoing_call.on('stream', render_video);
			}
			catch (error) {
				log('app_log', `failed to start play screen cast. ${error}`);
				console.error(error);
				console.log(error.stack);
				return;
			}
			document.getElementById("screencast_button").disabled = true;
		}
	</script>
<script type="text/javascript" src="main-67d5f4.js"></script></body>

</html>